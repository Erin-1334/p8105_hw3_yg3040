---
title: "Homework 3 solutions"
author: "Yue Ge"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: github_document

---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)

library(p8105.datasets)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


### Problem 1

#### Read in the data

```{r}
data("ny_noaa")
```

#### Answer questions about the data

This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Variables include weather station id, date of observation,  (tenths of mm), snowfall (mm), snow depth (mm), and min and max temperature (tenths of degrees C).

Below we clean the data, creating separate variables for year, month, and day and converting `tmax` and `tmin` to numeric. We find that 0 is the most commonly observed value for snowfall. This is because most days of the year, it does not snow at all in NY. The second most commonly observed value is `NA`, indicating missingness. Other common values are 13, 25, and 51, suggesting that snowfall is originally recorded in fractions of an inch and converted to mm.

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

Below is a two-panel plot showing the average max temperature in January and in July in each station across years. As expected, the mean temperature in January is much lower than the mean temperature in July for all stations and across all years. All stations appear to follow similar trends of temperature peaks and valleys within a month across the years, i.e. when one station has a high monthly mean temperature for a given year, most other stations also have a high monthly mean temperature for that year. We do see one uncharacteristically cold station in July of 1987 or 1988, as well as a few other less drastic outliers.

```{r}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```

Below we show a two-panel plot including (i) a hex plot of `tmax` vs `tmin` for the full dataset; and (ii) a ridge plot showing the distribution of snowfall values (in mm) greater than 0 and less than 100 separately by year. 

From the hex plot we see that while there is some variability, the majority of the data cluster tightly in the center of the distribution. In relatively rare cases, it seems that `tmax` is less than `tmin`, which raises questions about data recording and quality.

From the ridge plot, we see a multimodal density of snowfall within a given year. Most stations see between 0 and  35 mm of snow in a year. Then there is a another group of stations that see about 45 mm of snow, and another group that sees nearly 80 mm. It is likely this multimodality stems from the conversion of measurements in one system (fractions of an inch) to another (using the metric system), which was also noted in the table of common values. 

```{r}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

hex + ridge
```

### Problem 2

#### Load, tidy, merge, and otherwise organize the data sets. 
```{r}
covar_df = 
  read_csv(
    "data/nhanes_covar.csv", 
    skip = 4, 
    na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  mutate(
    sex = factor(sex, labels = c("Male", "Female")),
    education = factor(education, labels = c("Less than high school", "High school equivalent", "More than high school"))
  )

accel_df = 
  read_csv(
    "data/nhanes_accel.csv", 
    na = c("0", ".", "NA", "")) |> 
  janitor::clean_names() |> 
  pivot_longer(
    starts_with("min"),
    names_to = "minute",
    names_prefix = "min",
    values_to = "mims")

final_df = 
  full_join(accel_df, covar_df, by = c("seqn")) |> 
  filter(age >= 21) |> 
  drop_na(sex, age, bmi, education) |>
  relocate(seqn, sex, age, bmi, education)
```
#### Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.
```{r}
covar_df |> 
  drop_na(sex, age, bmi, education) |> 
  janitor::tabyl(sex, education) |> 
  print()

covar_df |> 
  drop_na(sex, age, bmi, education) |> 
    ggplot(aes(x = age, fill = sex)) +
      geom_density(alpha = .4, adjust = .5) +
      facet_grid(. ~ education)
```
_The number of men and women in "Less than high school" and "More than high school"categories are alike. The number of men in "High school equivalent" category is 50% larger than the number of women in "High school equivalent" category._

_The age distribution plot, divided by education levels and sex, reveals distinct patterns. In the "Less than high school" group, men are more prevalent in younger to middle adulthood (30â€“50 years), while women have a slightly higher density in older age ranges (60+ years). The "High school equivalent" group shows a more balanced distribution across ages, but women outnumber men in the 70+ range. In the "More than high school" group, the density of older women (around 70 years) is notably higher, while men peak in middle adulthood (around 50 years), indicating that women in this group tend to be older._

#### Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.
```{r}
final_df |> 
  group_by(seqn) |> 
  mutate(total_activity = sum(mims)) |> 
  drop_na(sex, age, education) |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    facet_grid(. ~ education) +
    labs(
      title = "Total Activity Against Age by Sex and Education",
      x = "Age",
      y = "Total Activity",
      color = "Sex"
    )
```
_

Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.
```{r}
final_df |> 
  drop_na(sex, education) |> 
  ggplot(aes(x = minute, y = mims, color = sex)) +
    geom_smooth(se = FALSE) +
    facet_grid(. ~ education) +
    labs(
      title = "24-Hour Activity Time Courses by Sex and Education",
      x = "Minute",
      y = "MIMS",
      color = "Sex"
    )
```

### Problem 3
#### Import, clean, and tidy these data, and describe the resulting dataset.
```{r}
jan_2020_citi_df =
  read_csv(
    "data/Jan 2020 Citi.csv", 
    na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  mutate(
    year = "2020",
    month = "Jan")

july_2020_citi_df =
  read_csv(
    "data/July 2020 Citi.csv", 
    na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  mutate(
    year = "2020",
    month = "July")

jan_2024_citi_df =
  read_csv(
    "data/Jan 2024 Citi.csv", 
    na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  mutate(
    year = "2024",
    month = "Jan")

july_2024_citi_df =
  read_csv(
    "data/july 2024 Citi.csv", 
    na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  mutate(
    year = "2024",
    month = "July")

citi_df = bind_rows(jan_2020_citi_df, july_2020_citi_df, jan_2024_citi_df, july_2024_citi_df)
```
_

#### Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.
```{r}
citi_df |> janitor::tabyl(member_casual, month, year)
```
_

#### Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.
```{r}
july_2024_citi_df |> 
  count(start_station_name, name = "n_obs") |> 
  filter(min_rank(desc(n_obs)) < 6) |> 
  print()
```

#### Make a plot to investigate the effects of day of the week, month, and year on median ride duration. This plot can include one or more panels, but should facilitate comparison across all variables of interest. Comment on your observations from this plot.
```{r}
weekdays_median_duration_p = 
  citi_df |> 
  group_by(year, month, weekdays) |> 
  mutate(median_duration = median(duration)) |> 
  ggplot(aes(x = weekdays, y = median_duration)) +
    geom_point()
```

#### There were relatively few electric Citi Bikes in 2020, but many more are available now. For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.
```{r}
citi_df |> 
  filter(year == "2024") |> 
  ggplot(aes(x = rideable_type, y = duration)) +
    geom_violin() +
    facet_grid(month ~ member_casual)
```



